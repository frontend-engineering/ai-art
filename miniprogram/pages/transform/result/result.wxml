<!--
  富贵变身模式结果页 - 复用原网页 ResultPage 样式
  Requirements: 2.3, 8.1-8.4
  新增: Live Photo 微动态功能
-->
<view class="result-page page-with-nav {{isElderMode ? 'elder-mode' : ''}}">
  <!-- 四角装饰背景 -->
  <corner-background />
  
  <!-- 背景 -->
  <view class="result-bg"></view>
  
  <!-- 大小字切换按钮（右上角，胶囊按钮下方） -->
  <view class="elder-mode-toggle-fixed" style="top: {{statusBarHeight + navBarHeight + 16}}px; right: {{menuRight}}px; left: auto;">
    <elder-mode-toggle />
  </view>
  
  <!-- 顶部导航栏 -->
  <view class="nav-bar" style="padding-top: {{statusBarHeight}}px; height: {{statusBarHeight + navBarHeight}}px;">
    <view class="nav-left">
      <view class="back-btn" bindtap="goBack">
        <text class="back-icon">‹</text>
      </view>
    </view>
    <text class="nav-title">生成结果</text>
    <view class="nav-right"></view>
  </view>
  
  <!-- 主内容区 -->
  <scroll-view class="result-content" scroll-y style="padding-top: {{statusBarHeight + navBarHeight}}px;">
    <!-- 图片展示区 -->
    <view class="image-section">
      <view class="image-frame">
        <view class="image-wrapper">
          <!-- Live Photo 标识 -->
          <view class="live-badge" wx:if="{{hasLivePhoto}}" bindtap="toggleLivePhoto">
            <view class="live-dot {{isPlayingLivePhoto ? 'playing' : ''}}"></view>
            <text class="live-text">Live</text>
          </view>
          
          <!-- 加载状态 -->
          <view class="loading-state" wx:if="{{!imageLoaded}}">
            <loading />
            <text class="loading-text">图片加载中...</text>
          </view>
          
          <!-- 静态图片 -->
          <image 
            class="result-image {{imageLoaded ? 'loaded' : ''}} {{isPlayingLivePhoto ? 'hidden' : ''}}"
            src="{{selectedImage}}"
            mode="widthFix"
            bindload="onImageLoad"
            wx:if="{{!isPlayingLivePhoto || !livePhotoUrl}}"
          />
          
          <!-- Live Photo 视频播放 -->
          <video 
            wx:if="{{isPlayingLivePhoto && livePhotoUrl}}"
            class="live-photo-video"
            src="{{livePhotoUrl}}"
            autoplay
            loop
            muted
            show-center-play-btn="{{false}}"
            controls="{{false}}"
            object-fit="contain"
          />
          
          <!-- AI标识 -->
          <view class="ai-badge">
            <text class="badge-icon">✓</text>
            <text class="badge-text">AI团圆照相馆</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 微动态生成进度 -->
    <view class="video-progress-section" wx:if="{{isGeneratingVideo}}">
      <view class="progress-card">
        <view class="progress-header">
          <text class="progress-title">🎬 生成微动态中</text>
        </view>
        <view class="progress-bar-wrapper">
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{videoProgress}}%"></view>
          </view>
          <text class="progress-text">{{videoProgressText}}</text>
        </view>
      </view>
    </view>
    
    <!-- 功能按钮区 -->
    <view class="action-section">
      <!-- 保存图片 -->
      <view 
        class="action-btn save-btn {{isSaving ? 'loading' : ''}}"
        bindtap="handleSaveImage"
      >
        <view class="btn-inner gold">
          <text class="btn-icon">📥</text>
          <text class="btn-text">{{isSaving ? '保存中...' : '保存至相册'}}</text>
        </view>
        <view class="btn-shine"></view>
      </view>
      
      <!-- 生成微动态 / 保存微动态 (暂时隐藏，后续版本放开) -->
      <view 
        wx:if="{{false}}"
        class="action-btn live-btn {{isGeneratingVideo ? 'loading' : ''}}"
        bindtap="{{hasLivePhoto ? 'handleSaveLivePhoto' : 'handleGenerateLivePhoto'}}"
      >
        <view class="btn-inner {{hasLivePhoto ? 'green' : 'orange'}}">
          <text class="btn-icon">{{hasLivePhoto ? '📹' : '✨'}}</text>
          <text class="btn-text">{{hasLivePhoto ? '保存微动态' : (isGeneratingVideo ? '生成中...' : '生成微动态')}}</text>
          <text class="premium-tag" wx:if="{{!hasLivePhoto && !isPremiumUser}}">尊享</text>
        </view>
      </view>
      
      <!-- 生成贺卡 (暂时隐藏，后续版本放开) -->
      <view wx:if="{{false}}" class="action-btn card-btn" bindtap="handleGenerateCard">
        <view class="btn-inner red">
          <text class="btn-icon">💌</text>
          <text class="btn-text">生成拜年贺卡</text>
        </view>
      </view>
      
      <!-- 定制产品 (暂时隐藏，后续版本放开) -->
      <view wx:if="{{false}}" class="action-btn product-btn" bindtap="handleOrderProduct">
        <view class="btn-inner purple">
          <text class="btn-icon">🖼️</text>
          <text class="btn-text">定制晶瓷画</text>
        </view>
      </view>
      
      <!-- 分享 -->
      <button 
        class="action-btn share-btn"
        open-type="share"
      >
        <view class="btn-inner transparent">
          <text class="btn-icon">👨‍👩‍👧‍👦</text>
          <text class="btn-text">分享家族群</text>
        </view>
      </button>
      
      <!-- 返回首页 -->
      <view 
        class="action-btn home-btn"
        bindtap="goHome"
      >
        <view class="btn-inner blue">
          <text class="btn-icon">🏠</text>
          <text class="btn-text">返回首页</text>
        </view>
      </view>
    </view>
    
    <!-- AI生成提示（合规要求） -->
    <view class="ai-notice">
      <text class="ai-notice-text">本服务为AI生成内容，结果仅供参考</text>
    </view>
  </scroll-view>
  
  <!-- 剩余次数显示框 - 页面底部 -->
  <view class="usage-count-bar">
    <view class="usage-count-content">
      <text class="usage-label">剩余次数：</text>
      <text class="usage-value">{{usageCount}}</text>
      <text class="usage-unit">次</text>
    </view>
  </view>
  
  <!-- 产品推荐弹窗 -->
  <product-recommendation 
    visible="{{showProductModal}}"
    imageUrl="{{selectedImage}}"
    bind:close="closeProductModal"
  />
  
  <!-- 分享弹窗 -->
  <share-modal 
    visible="{{showShareModal}}"
    imageUrl="{{selectedImage}}"
    bind:close="closeShareModal"
  />
  
  <!-- 支付弹窗 -->
  <payment-modal 
    visible="{{showPaymentModal}}"
    generationId="{{generationId}}"
    currentPaymentStatus="{{paymentStatus}}"
    bind:complete="onPaymentComplete"
    bind:close="closePaymentModal"
  />
  
  <!-- 使用次数提醒弹窗 -->
  <usage-modal 
    visible="{{showUsageModal}}"
    modalType="{{usageModalType}}"
    usageCount="{{usageCount}}"
    bind:close="onUsageModalClose"
    bind:share="onUsageModalShare"
    bind:payment="onUsageModalPayment"
  />
</view>
