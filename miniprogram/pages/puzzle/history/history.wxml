<!--
  æ—¶ç©ºæ‹¼å›¾æ¨¡å¼å†å²è®°å½•é¡µ
  Requirements: 2.2, 11.1-11.4
-->
<view class="history-page page-with-nav {{isElderMode ? 'elder-mode' : ''}}">
  <corner-background />
  
  <image class="history-bg-image" src="{{commonBgUrl}}" mode="aspectFill" />
  <view class="history-bg"></view>
  
  <!-- å¤§å°å­—åˆ‡æ¢æŒ‰é’®ï¼ˆå³ä¸Šè§’ï¼Œèƒ¶å›ŠæŒ‰é’®ä¸‹æ–¹ï¼‰ -->
  <view class="elder-mode-toggle-fixed" style="top: {{statusBarHeight + navBarHeight + 16}}px; right: {{menuRight}}px; left: auto;">
    <elder-mode-toggle />
  </view>
  
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="nav-bar" style="padding-top: {{statusBarHeight}}px; height: {{statusBarHeight + navBarHeight}}px;">
    <view class="nav-left">
      <view class="back-btn" bindtap="goBack">
        <text class="back-icon">â€¹</text>
      </view>
    </view>
    <text class="nav-title">æˆ‘çš„è®°å½•</text>
    <view class="nav-right"></view>
  </view>
  
  <!-- å†…å®¹åŒºåŸŸ -->
  <scroll-view 
    class="history-content" 
    scroll-y
    refresher-enabled
    bindrefresherrefresh="onPullDownRefresh"
    style="padding-top: {{statusBarHeight + navBarHeight}}px;"
  >
    <!-- åŠ è½½ä¸­ -->
    <view class="loading-state" wx:if="{{loading}}">
      <loading />
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
    
    <!-- é”™è¯¯çŠ¶æ€ -->
    <view class="error-state" wx:elif="{{error}}">
      <text class="error-icon">âš ï¸</text>
      <text class="error-text">{{error}}</text>
      <view class="retry-btn" bindtap="fetchHistory">
        <text class="retry-text">é‡è¯•</text>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:elif="{{records.length === 0}}">
      <text class="empty-icon">ğŸ§©</text>
      <text class="empty-text">æš‚æ— ç”Ÿæˆè®°å½•</text>
      <view class="create-btn" bindtap="goCreate">
        <text class="create-text">å»åˆ¶ä½œ</text>
      </view>
    </view>
    
    <!-- è®°å½•åˆ—è¡¨ -->
    <view class="record-grid" wx:else>
      <view 
        wx:for="{{records}}" 
        wx:key="id"
        class="record-item {{item.status !== 'completed' ? 'disabled' : ''}}"
        bindtap="handleRecordClick"
        data-record="{{item}}"
      >
        <view class="record-image-wrapper">
          <image 
            wx:if="{{item.generatedImage || (item.generatedImages && item.generatedImages[0])}}"
            class="record-image"
            src="{{item.generatedImage || item.generatedImages[0]}}"
            mode="aspectFill"
            lazy-load
          />
          <image 
            wx:elif="{{item.originalImages && item.originalImages[0]}}"
            class="record-image original"
            src="{{item.originalImages[0]}}"
            mode="aspectFill"
            lazy-load
          />
          <view wx:else class="record-placeholder">
            <text class="placeholder-icon">ğŸ–¼ï¸</text>
          </view>
          
          <view class="status-badge {{utils.getStatusClass(item.status)}}">
            <text class="status-text">{{utils.getStatusText(item.status)}}</text>
          </view>
          
          <view 
            class="delete-btn" 
            catchtap="handleDelete"
            data-id="{{item.id}}"
          >
            <text class="delete-icon">Ã—</text>
          </view>
        </view>
        
        <view class="record-info">
          <text class="record-date">{{utils.formatDate(item.createdAt)}}</text>
        </view>
      </view>
    </view>
  </scroll-view>
</view>

<wxs module="utils">
module.exports = {
  formatDate: function(dateStr) {
    if (!dateStr) return '';
    var date = getDate(dateStr);
    var month = date.getMonth() + 1;
    var day = date.getDate();
    var hour = date.getHours();
    var minute = date.getMinutes();
    return (month < 10 ? '0' + month : month) + '/' + 
           (day < 10 ? '0' + day : day) + ' ' + 
           (hour < 10 ? '0' + hour : hour) + ':' + 
           (minute < 10 ? '0' + minute : minute);
  },
  getStatusText: function(status) {
    var map = {
      pending: 'ç­‰å¾…ä¸­',
      processing: 'ç”Ÿæˆä¸­',
      completed: 'å·²å®Œæˆ',
      failed: 'å¤±è´¥'
    };
    return map[status] || 'å·²å®Œæˆ';
  },
  getStatusClass: function(status) {
    var map = {
      pending: 'status-pending',
      processing: 'status-processing',
      completed: 'status-completed',
      failed: 'status-failed'
    };
    return map[status] || 'status-completed';
  }
}
</wxs>
