<!--
  时空拼图模式上传页 - 5个独立图片框
  Requirements: 2.2, 6.1-6.5
-->
<view class="upload-page page-with-nav {{isElderMode ? 'elder-mode' : ''}}">
  <!-- 四角装饰背景 -->
  <corner-background />
  
  <!-- 背景 -->
  <image class="upload-bg-image" src="{{commonBgUrl}}" mode="aspectFill" />
  <view class="upload-bg"></view>
  
  <!-- 大小字切换按钮（右上角，胶囊按钮下方） -->
  <view class="elder-mode-toggle-fixed" style="top: {{statusBarHeight + navBarHeight + 16}}px; right: {{menuRight}}px; left: auto;">
    <elder-mode-toggle />
  </view>
  
  <!-- 顶部导航栏 -->
  <view class="nav-bar" style="padding-top: {{statusBarHeight}}px; height: {{statusBarHeight + navBarHeight}}px;">
    <view class="nav-left">
      <view class="back-btn" bindtap="goBack">
        <text class="back-icon">‹</text>
      </view>
    </view>
    <text class="nav-title">上传照片</text>
    <view class="nav-right"></view>
  </view>
  
  <!-- 主内容区 -->
  <view class="upload-content" style="padding-top: {{statusBarHeight + navBarHeight + 32}}px;">
    <!-- 标题说明 -->
    <view class="title-section">
      <text class="title-text">上传家人照片</text>
      <text class="subtitle-text">最多可选择5张，AI将为您合成时空全家福</text>
    </view>
    
    <!-- 错误提示 -->
    <view class="error-toast" wx:if="{{errorMessage}}">
      <text class="error-icon">⚠️</text>
      <text class="error-text">{{errorMessage}}</text>
      <view class="error-close" bindtap="clearError">
        <text class="close-icon">✕</text>
      </view>
    </view>
    
    <!-- 5个图片框布局 -->
    <view class="upload-grid">
      <!-- 第一行：2个框 -->
      <view class="upload-row">
        <view class="upload-box" bindtap="handleUploadClick" data-index="0">
          <image 
            wx:if="{{selectedImages[0]}}" 
            class="uploaded-image" 
            src="{{selectedImages[0]}}" 
            mode="aspectFill"
          />
          <image 
            wx:else 
            class="placeholder-image" 
            src="{{cameraUploadUrl}}" 
            mode="scaleToFill"
          />
          <view wx:if="{{selectedImages[0]}}" class="delete-btn" catchtap="removeImage" data-index="0">
            <text class="delete-icon">✕</text>
          </view>
        </view>
        
        <view class="upload-box" bindtap="handleUploadClick" data-index="1">
          <image 
            wx:if="{{selectedImages[1]}}" 
            class="uploaded-image" 
            src="{{selectedImages[1]}}" 
            mode="aspectFill"
          />
          <image 
            wx:else 
            class="placeholder-image" 
            src="{{cameraUploadUrl}}" 
            mode="scaleToFill"
          />
          <view wx:if="{{selectedImages[1]}}" class="delete-btn" catchtap="removeImage" data-index="1">
            <text class="delete-icon">✕</text>
          </view>
        </view>
      </view>
      
      <!-- 第二行：3个框 -->
      <view class="upload-row">
        <view class="upload-box" bindtap="handleUploadClick" data-index="2">
          <image 
            wx:if="{{selectedImages[2]}}" 
            class="uploaded-image" 
            src="{{selectedImages[2]}}" 
            mode="aspectFill"
          />
          <image 
            wx:else 
            class="placeholder-image" 
            src="{{cameraUploadUrl}}" 
            mode="scaleToFill"
          />
          <view wx:if="{{selectedImages[2]}}" class="delete-btn" catchtap="removeImage" data-index="2">
            <text class="delete-icon">✕</text>
          </view>
        </view>
        
        <view class="upload-box" bindtap="handleUploadClick" data-index="3">
          <image 
            wx:if="{{selectedImages[3]}}" 
            class="uploaded-image" 
            src="{{selectedImages[3]}}" 
            mode="aspectFill"
          />
          <image 
            wx:else 
            class="placeholder-image" 
            src="{{cameraUploadUrl}}" 
            mode="scaleToFill"
          />
          <view wx:if="{{selectedImages[3]}}" class="delete-btn" catchtap="removeImage" data-index="3">
            <text class="delete-icon">✕</text>
          </view>
        </view>
        
        <view class="upload-box" bindtap="handleUploadClick" data-index="4">
          <image 
            wx:if="{{selectedImages[4]}}" 
            class="uploaded-image" 
            src="{{selectedImages[4]}}" 
            mode="aspectFill"
          />
          <image 
            wx:else 
            class="placeholder-image" 
            src="{{cameraUploadUrl}}" 
            mode="scaleToFill"
          />
          <view wx:if="{{selectedImages[4]}}" class="delete-btn" catchtap="removeImage" data-index="4">
            <text class="delete-icon">✕</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 提示文字 -->
    <view class="upload-tips">
      <text class="tips-count">已上传 {{uploadedCount}}/5 张照片</text>
      <text class="tips-hint">点击框内上传或更换照片</text>
    </view>
    
    <!-- 下一步按钮 - 始终显示 -->
    <view class="action-buttons">
      <button 
        class="next-btn {{isProcessing ? 'disabled' : ''}}" 
        bindtap="goToTemplate"
        disabled="{{isProcessing}}"
      >
        下一步：选择模板
      </button>
    </view>
    
    <!-- 示例提示 -->
    <view class="example-tips">
      <view class="tip-item">
        <text class="tip-icon">✓</text>
        <text class="tip-text">可上传不同年代的照片</text>
      </view>
      <view class="tip-item">
        <text class="tip-icon">✓</text>
        <text class="tip-text">人脸清晰可见</text>
      </view>
      <view class="tip-item">
        <text class="tip-icon">✓</text>
        <text class="tip-text">支持 JPG、PNG 格式，最大 10MB</text>
      </view>
    </view>
    
    <!-- 底部提示 -->
    <view class="bottom-tips">
      <text class="tips-text">💡 提示：上传不同年代的家人照片，AI将合成穿越时空的全家福</text>
    </view>
    
    <!-- AI生成提示（合规要求） -->
    <view class="ai-notice">
      <text class="ai-notice-text">本服务为AI生成内容，结果仅供参考</text>
    </view>
  </view>
  
  <!-- 处理中状态 - 页面居中 -->
  <view class="processing-overlay" wx:if="{{isProcessing}}">
    <view class="processing-content">
      <view class="loading-spinner">
        <loading showText="{{false}}" />
      </view>
      <text class="status-text">{{statusText}}</text>
      <view class="progress-bar" wx:if="{{uploadProgress > 0 && uploadProgress < 100}}">
        <view class="progress-fill" style="width: {{uploadProgress}}%"></view>
      </view>
    </view>
  </view>
  
  <!-- 支付弹窗 -->
  <payment-modal
    visible="{{showPaymentModal}}"
    currentPaymentStatus="{{currentPaymentStatus}}"
    bind:complete="handlePaymentComplete"
    bind:close="handlePaymentClose"
  />
</view>
