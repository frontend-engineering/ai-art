# 画布定位功能实现总结

## 概述

成功实现了任务4"画布定位功能实现"的所有子任务,包括人脸提取API、CanvasPositioning组件、辅助功能和定位信息传递。

## 已完成的功能

### 4.1 人脸提取API ✅

**后端实现:**
- 添加了 `/api/extract-faces` API端点
- 实现了 `extractFaces()` 函数,调用Python脚本提取人脸
- 更新了 `extract_faces.py` 脚本,支持从URL下载图片
- 添加了 `requests` 依赖到 `requirements.txt`

**前端实现:**
- 在 `src/lib/api.ts` 中添加了 `faceAPI.extractFaces()` 函数
- 定义了 `FaceData` 和 `ExtractFacesResult` 类型

**功能特性:**
- 支持从URL或本地路径提取人脸
- 返回人脸图片的base64编码和位置信息(bbox)
- 包含置信度评分,过滤低质量人脸
- 自动扩展人脸边界(增加10%边距)

### 4.2 CanvasPositioning组件 ✅

**组件位置:** `src/components/CanvasPositioning.tsx`

**核心功能:**
- 展示背景模板和提取的人脸
- 支持拖拽人脸到任意位置
- 支持缩放人脸(0.5x - 3.0x)
- 支持旋转人脸(0° - 360°)
- 显示网格线辅助定位
- 多人脸管理和选择

**交互特性:**
- 鼠标和触摸屏双重支持
- 实时拖拽反馈
- 选中人脸高亮显示
- 底部控制面板调整参数

### 4.3 辅助功能 ✅

**网格线功能:**
- 40x40像素网格
- 可切换显示/隐藏
- 半透明白色线条

**对齐线和吸附功能:**
- 自动检测与其他人脸的对齐关系
- 检测与画布中心的对齐关系
- 10像素吸附阈值
- 实时显示紫色虚线对齐线
- 支持垂直和水平对齐
- 可切换启用/禁用

**对齐检测点:**
- 人脸左边、中心、右边
- 人脸上边、中心、下边
- 画布中心点

### 4.4 定位信息传递 ✅

**后端更新:**
- `generateArtPhoto()` 函数接受 `facePositions` 参数
- 将人脸位置信息添加到火山引擎API请求体中
- 支持可选的定位信息传递

**前端更新:**
- `generateArtPhoto()` API函数接受 `facePositions` 参数
- GeneratorPage集成了完整的画布定位流程
- 添加了"画布定位"按钮(仅在多张照片时显示)
- 生成时自动传递定位信息给AI API

**工作流程:**
1. 用户上传多张照片
2. 点击"画布定位"按钮
3. 系统提取所有人脸
4. 显示CanvasPositioning组件
5. 用户调整人脸位置、大小、旋转
6. 点击"完成"保存定位信息
7. 生成艺术照时传递定位信息给AI

## 技术实现细节

### 人脸提取流程

```
用户上传照片 → 上传到OSS → 调用extract_faces API 
→ Python脚本下载图片 → OpenCV检测人脸 
→ 返回base64编码的人脸图片和位置信息
```

### 画布定位数据结构

```typescript
interface FacePosition {
  id: string;
  imageBase64: string;
  x: number;           // 画布上的X坐标
  y: number;           // 画布上的Y坐标
  scale: number;       // 缩放比例(0.5-3.0)
  rotation: number;    // 旋转角度(0-360)
  bbox: {              // 原始人脸位置
    x: number;
    y: number;
    width: number;
    height: number;
  };
  sourceImage: string; // 来源图片URL
}
```

### AI生成API集成

定位信息以以下格式传递给火山引擎API:

```json
{
  "face_positions": [
    {"x": 100, "y": 150, "scale": 1.2, "rotation": 0},
    {"x": 300, "y": 150, "scale": 1.0, "rotation": 5}
  ]
}
```

## 用户体验优化

1. **智能提示:** 检测到多张照片时提示用户使用画布定位
2. **状态指示:** 完成定位后按钮变绿并显示"已完成画布定位"
3. **可选功能:** 用户可以选择跳过画布定位,直接生成
4. **实时反馈:** 拖拽时显示对齐线,提供视觉反馈
5. **移动端适配:** 支持触摸操作,适配移动设备

## 依赖更新

### Python依赖
- 添加 `requests>=2.31.0` 到 `backend/utils/requirements.txt`

### 前端组件
- 使用 `framer-motion` 实现动画效果
- 使用 `sonner` 显示提示信息

## 测试建议

1. **单张照片测试:** 验证跳过画布定位的流程
2. **多张照片测试:** 验证人脸提取和画布定位流程
3. **边界测试:** 测试人脸拖拽到画布边缘的行为
4. **缩放旋转测试:** 测试极限缩放和旋转值
5. **对齐吸附测试:** 测试对齐线和吸附功能的准确性
6. **移动端测试:** 在移动设备上测试触摸操作

## 后续优化建议

1. **性能优化:** 大图片的人脸提取可能较慢,考虑添加进度提示
2. **批量操作:** 支持批量调整多个人脸的大小或旋转
3. **撤销重做:** 添加撤销/重做功能
4. **预设位置:** 提供常用的人脸布局预设
5. **智能建议:** AI自动推荐最佳人脸位置

## 符合的需求

- ✅ Requirements 9.1: 人脸提取
- ✅ Requirements 9.2: 画布界面
- ✅ Requirements 9.3: 拖拽、缩放、旋转
- ✅ Requirements 9.4: 网格线和对齐辅助
- ✅ Requirements 9.5: 定位信息传递给AI

## 实现日期

2026-01-03
