# 功能对比与差异分析

## 概述

本文档对比了当前代码库已实现的功能与PRD/技术方案中要求的功能,明确列出了需要新增、修改和重新实现的功能点。

## 已实现功能 ✅

### 1. 基础架构
- ✅ React + TypeScript前端框架
- ✅ Express后端服务
- ✅ 火山引擎API集成(基础版)
- ✅ 腾讯云OSS图片存储
- ✅ 前端路由(LandingPage + GeneratorPage)

### 2. 图片上传功能
- ✅ 支持多张照片上传(最多10张)
- ✅ 支持拍照功能
- ✅ 图片预览和删除

### 3. 模板选择功能
- ✅ 模板列表展示
- ✅ 模板选择和高亮
- ✅ 模板缓存到localStorage

### 4. 基础生成功能
- ✅ 调用火山引擎API生成艺术照
- ✅ 轮询任务状态
- ✅ 生成进度展示
- ✅ 结果图片展示

### 5. 历史记录功能
- ✅ 历史记录展示(localStorage)
- ✅ 历史记录点击查看
- ✅ 重生成功能(3次限制)

### 6. UI组件
- ✅ Background组件
- ✅ HelpModal组件
- ✅ PaymentModal组件(基础版)
- ✅ ImagePreviewModal组件
- ✅ HistoryItem组件

## 需要新增的功能 🆕

### 1. 画布定位功能 ⭐ 核心功能 (新增)
**当前状态**: 无画布定位功能,直接上传多人照片生成
**需要实现**:
- 人脸提取功能(extract_faces.py)
- CanvasPositioning组件
- 拖拽、缩放、旋转人脸功能
- 网格线和对齐辅助
- 定位信息传递给AI接口

**优先级**: 🔴 最高
**预计工时**: 3-4天
**原因**: 解决多人合成时位置不合理的问题,避免AI自动布局导致的效果差

### 2. 4选1生成策略 ⭐ 核心功能
**当前状态**: 只生成1张图片
**需要实现**:
- 使用即梦AI的 `sequential_image_generation: auto` 参数
- 设置 `max_images: 4` 生成4张图片
- 实现流式响应处理(SSE)
- 创建FourGridSelector组件展示4宫格
- 实现图片选择逻辑
- 支持传递画布定位信息

**优先级**: 🔴 最高
**预计工时**: 2-3天

### 3. 支付系统 ⭐ 核心功能
**当前状态**: PaymentModal只是UI,无实际支付功能
**需要实现**:
- 集成微信支付API
- 创建支付订单表(payment_orders)
- 实现支付回调处理
- 实现支付状态更新
- 实现三种套餐(免费/9.9元/29.9元)

**优先级**: 🔴 最高
**预计工时**: 3-4天

### 4. 水印功能 ⭐ 核心功能
**当前状态**: 无水印功能
**需要实现**:
- 使用API的 `watermark` 参数
- 创建Python脚本添加自定义水印(二维码+文字)
- 实现付费后去水印逻辑

**优先级**: 🔴 最高
**预计工时**: 1-2天

### 5. 用户鉴权系统
**当前状态**: 无用户系统
**需要实现**:
- 生成唯一用户ID(UUID)
- 创建users表
- 实现用户会话管理
- 关联用户数据

**优先级**: 🟡 高
**预计工时**: 2天

### 6. 数据库持久化
**当前状态**: 使用localStorage,数据易丢失
**需要实现**:
- 创建MySQL数据库
- 设计4个表(users, generation_history, payment_orders, product_orders)
- 实现数据库连接池
- 迁移localStorage数据到数据库

**优先级**: 🟡 高
**预计工时**: 2-3天

### 7. Python工具层
**当前状态**: 无Python工具层
**需要实现**:
- compress_image.py (图片压缩)
- check_face.py (人脸检测)
- extract_faces.py (人脸提取) - 新增
- add_watermark.py (水印添加)
- export_orders_excel.py (订单Excel导出) - 新增
- Node.js调用Python脚本的逻辑

**优先级**: 🟡 高
**预计工时**: 3-4天

### 8. 微动态生成
**当前状态**: 无微动态功能
**需要实现**:
- 调用火山引擎视频生成API
- 实现Live Photo格式转换(FFmpeg)
- 权限控制(仅尊享包用户)

**优先级**: 🟢 中
**预计工时**: 2-3天

### 9. 实体产品对接 (MVP简化版)
**当前状态**: 无实体产品功能
**需要实现**:
- 产品推荐UI
- 产品预览功能
- 订单收集功能
- Excel导出功能(人工处理订单)

**注意**: MVP阶段不对接淘宝/1688 API,采用Excel导出+人工处理的方式,避免API申请和调试的时间成本

**优先级**: 🟢 中
**预计工时**: 2天

### 10. 性能优化
**当前状态**: 无缓存和CDN
**需要实现**:
- Redis缓存(模板、会话)
- CDN配置
- 弹性扩容配置

**优先级**: 🟢 中
**预计工时**: 1-2天

### 11. 错误处理增强
**当前状态**: 基础错误处理
**需要实现**:
- API重试逻辑
- 错误日志记录
- 参数校验增强
- 友好错误提示

**优先级**: 🟢 中
**预计工时**: 1-2天

## 需要修改的功能 🔧

### 1. 火山引擎API调用
**当前实现**: 使用旧版API参数
**需要修改**:
- 更新为 doubao-seedream-4.5 模型
- 添加 `sequential_image_generation` 参数
- 添加 `stream` 参数支持流式输出
- 添加 `watermark` 参数
- 添加 `face_positions` 参数支持画布定位

**优先级**: 🔴 最高
**预计工时**: 1天

### 2. GeneratorPage组件
**当前实现**: 单图生成流程
**需要修改**:
- 添加画布定位步骤
- 支持4宫格展示
- 添加图片选择逻辑
- 集成支付流程
- 添加权限控制

**优先级**: 🔴 最高
**预计工时**: 3-4天

### 3. PaymentModal组件
**当前实现**: 只是UI展示
**需要修改**:
- 集成真实支付API
- 添加套餐选择逻辑
- 处理支付回调
- 更新用户状态

**优先级**: 🔴 最高
**预计工时**: 2天

### 4. 历史记录功能
**当前实现**: 存储在localStorage
**需要修改**:
- 改为从数据库读取
- 支持分页查询
- 添加付费状态显示

**优先级**: 🟡 高
**预计工时**: 1天

### 5. 后端server.js
**当前实现**: 基础API端点
**需要修改**:
- 添加数据库连接
- 添加用户鉴权中间件
- 添加支付相关端点
- 添加Python脚本调用逻辑

**优先级**: 🟡 高
**预计工时**: 2-3天

## 需要删除的功能 ❌

### 1. 旧版重生成逻辑
**原因**: 与4选1策略冲突,需要重新设计

### 2. localStorage历史记录
**原因**: 迁移到数据库后不再需要

### 3. 旧版API参数
**原因**: 升级到新版API后废弃

## 开发优先级建议

### Phase 1: 核心功能 (1-2周)
1. 🔴 画布定位功能 (新增,解决多人合成位置问题)
2. 🔴 4选1生成策略
3. 🔴 水印功能
4. 🔴 支付系统
5. 🟡 用户鉴权
6. 🟡 数据库持久化

### Phase 2: 增强功能 (1周)
7. 🟡 Python工具层
8. 🟢 性能优化
9. 🟢 错误处理增强

### Phase 3: 高级功能 (1-2周)
10. 🟢 微动态生成
11. 🟢 实体产品对接 (Excel导出,人工处理)

## 总结

**已实现**: 约30%的功能
**需要新增**: 约55%的功能 (包含画布定位和Excel导出)
**需要修改**: 约15%的功能

**预计总工时**: 22-32个工作日
**建议上线时间**: 2026年1月20日(距今约18天)

**关键路径**:
1. 画布定位功能 (4天) - 新增,优先级最高
2. 4选1生成策略 (3天)
3. 支付系统 (4天)
4. 水印功能 (2天)
5. 用户鉴权 + 数据库 (4天)
6. Python工具层 (4天)
7. 测试与优化 (4天)

**风险提示**:
- 画布定位功能是新增需求,需要额外开发时间,但能显著提升多人合成效果
- 微信支付接入可能需要额外的审核时间
- 数据库迁移需要谨慎处理,避免数据丢失
- 性能优化需要在生产环境测试
- 实体产品对接采用Excel导出+人工处理,避免淘宝/1688 API申请和调试的时间成本,快速落地
